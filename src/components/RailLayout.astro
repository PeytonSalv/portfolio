---
interface RailItem {
  id: string;
  label: string;
  sublabel?: string;
}

interface Props {
  items?: RailItem[];
  class?: string;
}

const { items = [], class: className = '' } = Astro.props;
---

<div class:list={['rail-layout', className]}>
  {items.length > 0 && (
    <aside class="rail" aria-label="Section navigation">
      <div class="rail-rule"></div>
      <nav class="rail-nav">
        {items.map((item, index) => (
          <a
            href={`#${item.id}`}
            class="rail-item"
            data-nav={item.id}
            aria-current="false"
          >
            <span class="rail-label">{item.label}</span>
            {item.sublabel && <span class="rail-sublabel">{item.sublabel}</span>}
          </a>
        ))}
      </nav>
    </aside>
  )}
  <div class="rail-content">
    <slot />
  </div>
</div>

<style>
  .rail-layout {
    display: grid;
    grid-template-columns: var(--rail-width) var(--rail-gap) minmax(0, var(--content-max));
    max-width: var(--container-max);
    margin: 0 auto;
    padding: 0 var(--container-padding);
  }

  .rail {
    position: relative;
    grid-column: 1;
  }

  .rail-rule {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 1px;
    background-color: var(--rule);
  }

  .rail-nav {
    position: sticky;
    top: var(--space-12);
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
    padding-right: var(--space-6);
  }

  .rail-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
    text-decoration: none;
    transition: opacity var(--transition-fast);
    opacity: 0.5;
  }

  .rail-item:hover,
  .rail-item.is-active {
    opacity: 1;
  }

  .rail-item.is-active .rail-label {
    color: var(--accent);
  }

  .rail-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
    color: var(--muted);
    transition: color var(--transition-fast);
  }

  .rail-sublabel {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--muted);
  }

  .rail-content {
    grid-column: 3;
    min-width: 0;
  }

  /* Mobile: hide rail completely */
  @media (max-width: 768px) {
    .rail-layout {
      display: block;
    }

    .rail {
      display: none;
    }

    .rail-content {
      width: 100%;
    }
  }
</style>

<script>
  function initRailHighlight() {
    // Get section IDs from nav items
    const navItems = document.querySelectorAll('.rail-item[data-nav]');
    if (navItems.length === 0) return;

    const ids = Array.from(navItems).map(item => item.getAttribute('data-nav')).filter(Boolean) as string[];
    const sections = ids.map(id => document.getElementById(id)).filter(Boolean) as HTMLElement[];
    const navLinks = new Map(
      ids.map(id => [id, document.querySelector(`[data-nav="${id}"]`) as HTMLElement | null])
    );

    if (sections.length === 0) return;

    const getActiveId = (): string => {
      const marker = window.innerHeight * 0.35;
      const firstId = ids[0];
      const lastId = ids[ids.length - 1];

      // Force last section near bottom of page
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 8) {
        return lastId;
      }

      // Force first section near top of page
      if (window.scrollY < 8) {
        return firstId;
      }

      // Find the last section whose top has crossed the marker
      let active = firstId;
      for (const section of sections) {
        const rect = section.getBoundingClientRect();
        if (rect.top <= marker) {
          active = section.id;
        } else {
          break;
        }
      }

      return active;
    };

    let current: string | null = null;

    const setActive = () => {
      const next = getActiveId();
      if (next === current) return;

      // Remove active state from current
      if (current && navLinks.get(current)) {
        const currentEl = navLinks.get(current);
        if (currentEl) {
          currentEl.classList.remove('is-active');
          currentEl.setAttribute('aria-current', 'false');
        }
      }

      // Add active state to next
      const el = navLinks.get(next);
      if (el) {
        el.classList.add('is-active');
        el.setAttribute('aria-current', 'true');
      }

      current = next;
    };

    const onScroll = () => requestAnimationFrame(setActive);
    window.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', onScroll);

    // Set initial state
    setActive();
  }

  // Run on initial load
  initRailHighlight();

  // Re-run after Astro page transitions
  document.addEventListener('astro:after-swap', initRailHighlight);
</script>
