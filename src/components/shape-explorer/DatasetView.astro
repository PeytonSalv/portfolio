---
interface Props {
  class?: string;
}

const { class: className = '' } = Astro.props;

// Single source of truth - abstract dataset
const dataset = [
  { id: 'a', name: 'Alpha', performance: 87, category: 'Primary', rank: 1, delta: 12.4 },
  { id: 'b', name: 'Beta', performance: 72, category: 'Secondary', rank: 3, delta: -3.2 },
  { id: 'c', name: 'Gamma', performance: 91, category: 'Primary', rank: 2, delta: 8.7 },
  { id: 'd', name: 'Delta', performance: 65, category: 'Tertiary', rank: 4, delta: -7.1 },
  { id: 'e', name: 'Epsilon', performance: 78, category: 'Secondary', rank: 5, delta: 2.3 },
  { id: 'f', name: 'Zeta', performance: 83, category: 'Primary', rank: 6, delta: 5.8 },
];
---

<div class:list={['dataset-view', className]} data-dataset-view>
  <!-- Table View -->
  <div class="view-panel active" data-view-panel="table">
    <svg viewBox="0 0 400 180" class="view-svg" role="img" aria-label="Data displayed as table">
      <style>
        .cell { font: 11px 'Inter', sans-serif; fill: #111111; }
        .cell-num { font: 11px 'IBM Plex Mono', monospace; fill: #5F6368; }
        .cell-delta-pos { font: 11px 'IBM Plex Mono', monospace; fill: #16a34a; }
        .cell-delta-neg { font: 11px 'IBM Plex Mono', monospace; fill: #dc2626; }
        .header { font: 9px 'IBM Plex Mono', monospace; fill: #71767B; text-transform: uppercase; letter-spacing: 0.08em; }
        .row-bg { fill: transparent; transition: fill 0.1s ease; }
        .table-row:hover .row-bg { fill: rgba(31, 58, 138, 0.06); }
      </style>

      <!-- Header -->
      <g class="table-header">
        <text x="12" y="20" class="header">Name</text>
        <text x="100" y="20" class="header">Perf</text>
        <text x="160" y="20" class="header">Category</text>
        <text x="280" y="20" class="header">Rank</text>
        <text x="340" y="20" class="header">Delta</text>
      </g>
      <line x1="0" y1="28" x2="400" y2="28" stroke="#E6E8EB" stroke-width="1"/>

      <!-- Rows -->
      {dataset.map((item, i) => (
        <g class="table-row" data-entity={item.id}>
          <rect x="0" y={36 + i * 24} width="400" height="24" class="row-bg"/>
          <text x="12" y={52 + i * 24} class="cell">{item.name}</text>
          <text x="100" y={52 + i * 24} class="cell-num">{item.performance}%</text>
          <text x="160" y={52 + i * 24} class="cell">{item.category}</text>
          <text x="280" y={52 + i * 24} class="cell-num">#{item.rank}</text>
          <text x="340" y={52 + i * 24} class={item.delta >= 0 ? 'cell-delta-pos' : 'cell-delta-neg'}>
            {item.delta >= 0 ? '+' : ''}{item.delta}%
          </text>
        </g>
      ))}
    </svg>
  </div>

  <!-- Cards View -->
  <div class="view-panel" data-view-panel="cards">
    <svg viewBox="0 0 400 180" class="view-svg" role="img" aria-label="Data displayed as cards">
      <style>
        .card-name { font: 500 11px 'Inter', sans-serif; fill: #111111; }
        .card-perf { font: 600 14px 'IBM Plex Mono', monospace; fill: #1F3A8A; }
        .card-meta { font: 9px 'IBM Plex Mono', monospace; fill: #71767B; }
        .card-rect { fill: white; stroke: #E6E8EB; stroke-width: 1; transition: stroke 0.1s ease; }
        .card:hover .card-rect { stroke: #1F3A8A; stroke-width: 1.5; }
        .bar-bg { fill: rgba(31, 58, 138, 0.1); }
        .bar-fill { fill: #1F3A8A; }
      </style>

      {dataset.map((item, i) => {
        const col = i % 3;
        const row = Math.floor(i / 3);
        const x = col * 130 + 5;
        const y = row * 88 + 2;
        return (
          <g class="card" data-entity={item.id} transform={`translate(${x}, ${y})`}>
            <rect width="122" height="82" rx="4" class="card-rect"/>
            <text x="10" y="22" class="card-name">{item.name}</text>
            <text x="10" y="40" class="card-perf">{item.performance}%</text>
            <rect x="10" y="50" width="100" height="4" rx="2" class="bar-bg"/>
            <rect x="10" y="50" width={item.performance} height="4" rx="2" class="bar-fill"/>
            <text x="10" y="70" class="card-meta">{item.category} Â· #{item.rank}</text>
          </g>
        );
      })}
    </svg>
  </div>

  <!-- Graph View -->
  <div class="view-panel" data-view-panel="graph">
    <svg viewBox="0 0 400 180" class="view-svg" role="img" aria-label="Data displayed as bar chart">
      <style>
        .bar-label { font: 9px 'IBM Plex Mono', monospace; fill: #71767B; }
        .bar-value { font: 600 10px 'IBM Plex Mono', monospace; fill: #1F3A8A; opacity: 0; transition: opacity 0.15s ease; }
        .bar-group:hover .bar-value { opacity: 1; }
        .bar { fill: rgba(31, 58, 138, 0.7); transition: fill 0.1s ease; }
        .bar-group:hover .bar { fill: #1F3A8A; }
        .axis { stroke: #E6E8EB; stroke-width: 1; }
      </style>

      <!-- Axes -->
      <line x1="30" y1="20" x2="30" y2="140" class="axis"/>
      <line x1="30" y1="140" x2="380" y2="140" class="axis"/>

      <!-- Y-axis labels -->
      <text x="24" y="24" class="bar-label" text-anchor="end">100</text>
      <text x="24" y="82" class="bar-label" text-anchor="end">50</text>
      <text x="24" y="140" class="bar-label" text-anchor="end">0</text>

      <!-- Bars -->
      {dataset.map((item, i) => {
        const barWidth = 45;
        const x = 45 + i * 55;
        const maxHeight = 115;
        const height = (item.performance / 100) * maxHeight;
        const y = 140 - height;
        return (
          <g class="bar-group" data-entity={item.id}>
            <rect x={x} y={y} width={barWidth} height={height} rx="2" class="bar"/>
            <text x={x + barWidth / 2} y="155" class="bar-label" text-anchor="middle">{item.name}</text>
            <text x={x + barWidth / 2} y={y - 6} class="bar-value" text-anchor="middle">{item.performance}%</text>
          </g>
        );
      })}
    </svg>
  </div>

  <!-- Overlay View -->
  <div class="view-panel" data-view-panel="overlay">
    <svg viewBox="0 0 400 180" class="view-svg" role="img" aria-label="Data displayed as sparkline with details on demand">
      <style>
        .grid-line { stroke: #E6E8EB; stroke-width: 1; opacity: 0.5; }
        .spark-line { fill: none; stroke: #1F3A8A; stroke-width: 2; }
        .data-point { fill: white; stroke: #1F3A8A; stroke-width: 2; cursor: pointer; transition: r 0.15s ease; }
        .data-point:hover { fill: #1F3A8A; }
        .tooltip { opacity: 0; transition: opacity 0.15s ease; pointer-events: none; }
        .data-point:hover + .tooltip { opacity: 1; }
        .tooltip-bg { fill: white; stroke: #1F3A8A; stroke-width: 1; }
        .tooltip-name { font: 500 10px 'Inter', sans-serif; fill: #111111; }
        .tooltip-perf { font: 600 12px 'IBM Plex Mono', monospace; fill: #1F3A8A; }
        .tooltip-meta { font: 9px 'IBM Plex Mono', monospace; fill: #71767B; }
        .tooltip-delta-pos { font: 9px 'IBM Plex Mono', monospace; fill: #16a34a; }
        .tooltip-delta-neg { font: 9px 'IBM Plex Mono', monospace; fill: #dc2626; }
        .point-label { font: 8px 'IBM Plex Mono', monospace; fill: #71767B; }
      </style>

      <!-- Background grid -->
      <line x1="30" y1="30" x2="370" y2="30" class="grid-line"/>
      <line x1="30" y1="70" x2="370" y2="70" class="grid-line"/>
      <line x1="30" y1="110" x2="370" y2="110" class="grid-line"/>

      <!-- Sparkline path -->
      {(() => {
        const points = dataset.map((item, i) => {
          const x = 50 + i * 60;
          const y = 120 - (item.performance / 100) * 90;
          return { x, y, item };
        });
        const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
        return <path d={pathD} class="spark-line"/>;
      })()}

      <!-- Data points with tooltips -->
      {dataset.map((item, i) => {
        const x = 50 + i * 60;
        const y = 120 - (item.performance / 100) * 90;
        const tooltipX = Math.min(Math.max(x - 45, 5), 305);
        return (
          <g data-entity={item.id}>
            <circle cx={x} cy={y} r="5" class="data-point"/>
            <g class="tooltip" transform={`translate(${tooltipX}, 130)`}>
              <rect width="90" height="48" rx="3" class="tooltip-bg"/>
              <text x="8" y="14" class="tooltip-name">{item.name}</text>
              <text x="8" y="28" class="tooltip-perf">{item.performance}%</text>
              <text x="8" y="40" class={item.delta >= 0 ? 'tooltip-delta-pos' : 'tooltip-delta-neg'}>
                {item.delta >= 0 ? '+' : ''}{item.delta}% vs baseline
              </text>
            </g>
            <text x={x} y="135" class="point-label" text-anchor="middle">{item.name.charAt(0)}</text>
          </g>
        );
      })}
    </svg>
  </div>
</div>

<style>
  .dataset-view {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 200px;
  }

  .view-panel {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition:
      opacity var(--transition-smooth),
      visibility var(--transition-smooth),
      transform var(--transition-smooth);
  }

  .view-panel.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .view-svg {
    width: 100%;
    max-width: 400px;
    height: auto;
  }
</style>
